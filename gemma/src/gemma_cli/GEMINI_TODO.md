# Gemma CLI Project TODO & Roadmap
*Generated by Gemini Analysis - 2025-10-15*

## üö® Executive Summary

**Current State**: Partially functional but not cohesive. Complex architecture with incomplete features blocking a working local LLM agent.

**Critical Blockers**:
1. **SECURITY** - Path traversal vulnerability in `config/settings.py`
2. **BROKEN** - Syntax error in `ingest` command prevents document ingestion
3. **COMPLEXITY** - Over-engineered RAG/Redis system makes local setup difficult
4. **INCOMPLETE** - MCP, deployment, and memory consolidation features are stubs

**Immediate Priority**: Simplify, secure, and stabilize the core chat functionality without external dependencies.

---

## üî• IMMEDIATE ACTIONS (Critical - Hours)

### 1. Critical Security Fix ‚ö†Ô∏è
**Priority: P0 - BLOCKER**

- [x] Replace `expand_path` in `config/settings.py` with `expand_path_secure` from `settings_secure.py` ‚úÖ
- [x] Search codebase for all uses of `expand_path` and update them ‚úÖ
- [x] Add security tests to prevent regression ‚úÖ
- [x] Document the vulnerability and fix in SECURITY.md ‚úÖ

**Impact**: Prevents potential path traversal attacks. **FIXED - January 2025**

**Files**: `config/settings.py` (fixed), `SECURITY_FIX_PATH_TRAVERSAL.md` (documentation)

### 2. Fix Broken Ingest Command
**Priority: P0 - BLOCKER**

- [x] Fix SyntaxError in `cli.py` line 620: `rag_manager.ingest_document(params=...)` ‚úÖ
- [x] Add required `params` argument to the call ‚úÖ
- [x] Add missing `try:` statement for exception handling ‚úÖ
- [ ] Test document ingestion end-to-end
- [ ] Add integration test for ingest command

**Impact**: Enables document ingestion for RAG functionality. **FIXED - January 2025**

**Files**: `cli.py` (fixed), `SYNTAX_FIX_REPORT.md` (documentation)

### 3. Enable Standalone Operation
**Priority: P0 - REQUIRED**

- [x] Change default `use_embedded_store = True` in RAG components ‚úÖ
- [x] Test that embedded vector store works without Redis ‚úÖ
- [x] Update documentation to reflect Redis is optional ‚úÖ
- [x] Verify onboarding wizard doesn't require Redis ‚úÖ
- [x] Create comprehensive test suite for embedded store ‚úÖ

**Impact**: Makes the agent work out-of-the-box without external services. **COMPLETED - January 2025**

**Files**: `config/settings.py`, `rag/hybrid_rag.py`, `rag/python_backend.py`, `rag/embedded_vector_store.py`, `onboarding/wizard.py`, `test_embedded_store.py`, `STANDALONE_OPERATION.md`, `CONFIGURATION_CHANGES_SUMMARY.md`

### 4. Simplify Model Configuration
**Priority: P1 - HIGH**

- [ ] Prioritize `--model` CLI argument in chat command
- [ ] Remove complex preset/profile logic for initial release
- [ ] Add simple model path validation
- [ ] Update help text and documentation

**Impact**: Reduces cognitive overhead for users and developers.

**Files**: `cli.py`, `core/gemma.py`, `commands/chat.py`

### 5. Disable Incomplete Features
**Priority: P1 - HIGH**

- [ ] Remove `mcp` command group from CLI
- [ ] Comment out memory consolidation logic in `rag/optimizations.py`
- [ ] Add TODO markers for future implementation
- [ ] Update CLI help to reflect current capabilities

**Impact**: Reduces confusion and dead code maintenance.

**Files**: `cli.py`, `commands/mcp_commands.py`, `rag/optimizations.py`

---

## üìã SHORT-TERM GOALS (1-2 Weeks)

### Refactor RAG System
**Priority: P1 - HIGH**

- [ ] Consolidate `HybridRAGManager` + `PythonRAGBackend` + `EmbeddedVectorStore` into single class
- [ ] Create `VectorStore` abstract base class
- [ ] Implement `EmbeddedVectorStore` and `RedisVectorStore` as plugins
- [ ] Default to embedded, make Redis truly optional
- [ ] Add comprehensive RAG tests

**Impact**: Major complexity reduction, better maintainability.

**Files**: `rag/hybrid_rag.py`, `rag/python_backend.py`, `rag/embedded_vector_store.py`

### Improve Model Discovery & Management
**Priority: P2 - MEDIUM**

- [ ] Implement `gemma model detect` to save findings to `config.toml`
- [ ] Add `gemma model add <path>` command
- [ ] Implement `gemma model list` with validation
- [ ] Add `gemma model use <name>` to set default
- [ ] Persist model configuration across sessions

**Impact**: Better UX for model management.

**Files**: `commands/model.py`, `config/settings.py`

### Refactor UI Console Pattern
**Priority: P2 - MEDIUM**

- [ ] Remove global singleton from `ui/console.py`
- [ ] Instantiate Console in `cli.py` main
- [ ] Pass console instance to components that need it
- [ ] Fix MagicMock anti-pattern for non-TTY
- [ ] Update tests to use proper mocking

**Impact**: Better testability, cleaner architecture.

**Files**: `ui/console.py`, `cli.py`, `tests/`

### Fix Hardcoded Paths
**Priority: P2 - MEDIUM**

- [ ] Create `core/utils.py` with `find_gemma_binary()` function
- [ ] Search PATH, common locations, env vars
- [ ] Update `core/gemma.py` to use utility function
- [ ] Update `onboarding/wizard.py` to use utility function
- [ ] Add configuration option for custom binary path

**Impact**: More portable, easier to distribute.

**Files**: `core/gemma.py`, `onboarding/wizard.py`, new `core/utils.py`

---

## üéØ MEDIUM-TERM GOALS (1-2 Months)

### Model Download Implementation
**Priority: P2 - MEDIUM**

- [ ] Implement `gemma model download <model-id>` command
- [ ] Support downloading from Kaggle/HuggingFace
- [ ] Add progress indicators
- [ ] Verify checksums after download
- [ ] Update configuration automatically

**Impact**: Streamlined user onboarding.

**Files**: `commands/model.py`

### Deployment System
**Priority: P3 - LOW**

- [ ] Complete `deployment/build_script.py` using PyInstaller
- [ ] Bundle dependencies and gemma.exe binary
- [ ] Create cross-platform builds (Windows, Linux, macOS)
- [ ] Test standalone executables on clean systems
- [ ] Document distribution process

**Impact**: True standalone application.

**Files**: `deployment/build_script.py`, `deployment/uvx_wrapper.py`

### RAG Backend Enhancement
**Priority: P3 - LOW**

- [ ] Evaluate SQLite-VSS as embedded store alternative
- [ ] Implement proper Redis connection pooling
- [ ] Add vector search performance benchmarks
- [ ] Add support for multiple embedding models
- [ ] Implement batch embedding optimization

**Impact**: Better performance for power users.

**Files**: `rag/`, new `rag/backends/`

### MCP Re-evaluation
**Priority: P3 - LOW**

- [ ] Decide: commit to MCP or remove entirely
- [ ] If keeping: implement minimal working version
- [ ] If removing: replace with simpler custom tool protocol
- [ ] Document decision in ADR (Architecture Decision Record)
- [ ] Update roadmap accordingly

**Impact**: Clear direction on tool-use capabilities.

**Files**: `mcp/` or new `tools/`

---

## üîß TECHNICAL DEBT

### Critical (P0)
- [ ] **Security**: `expand_path` vulnerability
- [ ] **Reliability**: Fix ingest command syntax error

### High (P1)
- [ ] **Portability**: Hardcoded paths to gemma.exe
- [ ] **Complexity**: Over-engineered RAG system
- [ ] **Dead Code**: Incomplete MCP features
- [ ] **Architecture**: Console singleton pattern

### Medium (P2)
- [ ] **Functionality**: Model detection doesn't persist config
- [ ] **Deployment**: No packaging/distribution system
- [ ] **Testing**: Missing integration tests for core paths
- [ ] **Documentation**: README doesn't reflect actual capabilities

### Low (P3)
- [ ] **Code Quality**: Redundant Pydantic models in settings
- [ ] **Performance**: Batch embedding is premature optimization
- [ ] **UX**: Onboarding wizard could be more robust

---

## üèóÔ∏è ARCHITECTURE RECOMMENDATIONS

### 1. Plugin Architecture for RAG
```python
# Proposed structure
class VectorStore(ABC):
    @abstractmethod
    def store(self, vectors, metadata): ...
    @abstractmethod
    def search(self, query_vector, k): ...

class EmbeddedVectorStore(VectorStore):
    """File-based store using numpy/pickle"""

class RedisVectorStore(VectorStore):
    """Optional Redis backend"""

class SQLiteVectorStore(VectorStore):
    """Future: SQLite-VSS backend"""
```

### 2. Centralized Executable Discovery
```python
# core/utils.py
def find_gemma_binary() -> Path:
    """Search for gemma.exe in:
    1. GEMMA_BINARY env var
    2. User config
    3. Common install locations
    4. System PATH
    """
```

### 3. Simplified Configuration
```python
# Consolidate to ~5 models instead of 15+
- AppConfig (general settings)
- ModelConfig (model paths/params)
- RAGConfig (vector store settings)
- UIConfig (theme/display)
- AdvancedConfig (optional overrides)
```

---

## üõ§Ô∏è SIMPLIFICATION ROADMAP

### Phase 1: Core Agent (2 weeks)
**Goal**: Stable, standalone chat agent

1. Fix security vulnerability
2. Fix broken ingest command
3. Default to embedded RAG
4. Remove MCP and incomplete features
5. Simplify model configuration
6. Single-file RAG implementation

**Success Criteria**:
- Can chat with model without external dependencies
- Can ingest documents for RAG
- No security vulnerabilities
- Clear, minimal codebase

### Phase 2: Polish & Features (4 weeks)
**Goal**: User-friendly, feature-complete agent

1. Complete model management commands
2. Implement model download
3. Refactor console pattern
4. Fix hardcoded paths
5. Add integration tests
6. Improve documentation

**Success Criteria**:
- Easy model discovery and management
- Portable across systems
- Well-tested core functionality
- Comprehensive user documentation

### Phase 3: Expansion (8 weeks)
**Goal**: Advanced capabilities

1. Implement deployment system
2. Re-implement or replace MCP
3. Add advanced RAG backends
4. Performance optimizations
5. Plugin system for extensibility

**Success Criteria**:
- Distributable standalone executable
- Tool-use capabilities
- High-performance RAG
- Extensible architecture

---

## üìä METRICS & SUCCESS CRITERIA

### Immediate Success (P0 Complete)
- [ ] Zero security vulnerabilities
- [ ] All CLI commands work without errors
- [ ] Agent runs without external dependencies
- [ ] Basic chat + RAG functionality works

### Short-term Success (Phase 1 Complete)
- [ ] <1000 lines of core business logic
- [ ] <10 Pydantic models in config
- [ ] 100% of advertised features work
- [ ] README accurately reflects capabilities
- [ ] Can set up in <5 minutes

### Medium-term Success (Phase 2 Complete)
- [ ] Integrated test suite >80% coverage
- [ ] Runs on Windows/Linux/macOS
- [ ] Model management is intuitive
- [ ] Documentation is comprehensive
- [ ] No hardcoded paths

### Long-term Success (Phase 3 Complete)
- [ ] Standalone executable <50MB
- [ ] Advanced RAG with tool-use
- [ ] Performance <500ms first token
- [ ] Plugin ecosystem emerging
- [ ] Active user community

---

## üöÄ GETTING STARTED

To work on this project:

1. **First PR**: Fix the security vulnerability (P0 blocker)
2. **Second PR**: Fix ingest command + enable fallback (P0 blockers)
3. **Third PR**: Simplify model config + disable MCP (P1 high priority)
4. **Fourth PR**: Refactor RAG system (P1 high priority)

**Then** move to short-term goals systematically.

---

## üìù NOTES

- **Be Ruthless**: Remove incomplete features. Finish core before expansion.
- **Test Everything**: Add tests as you simplify. Prevent regressions.
- **Document Decisions**: Use ADRs for major architectural changes.
- **User First**: Every change should make the agent easier to use.
- **Performance Later**: Get it working, then get it fast.

---

*Last Updated: 2025-10-15*
*Next Review: After Phase 1 completion*
